#!/usr/bin/env bash

# This script propagates the extracted C and assembly code for miTLS and 
# HACL* out into standalone directories.


print_usage ()
{
  cat <<HELP
Usage:  MakeSourceDrop destination_path
  make-source-drop ~/drops/drop12
  
The directory path will be created if it doesn't already exist.
HELP
}

if [[ $1 == "" ]]; then
  print_usage
  exit 0
fi

# set current directory to the directory of this script
cd "${BASH_SOURCE%/*}" || exit 

MITLS_EXTRACT=mitls-fstar/src/tls/extract
KREMLIB=kremlin/kremlib
HACL=$HACL_HOME/secure_api

mkdir -p $1/mitls
rm $1/mitls/*.c
rm $1/mitls/*.h
cp $MITLS_EXTRACT/Kremlin-library/*.c $1/mitls
cp $MITLS_EXTRACT/Kremlin-library/*.h $1/mitls

mkdir -p $1/quiccrypto
mkdir -p $1/quiccrypto/amd64
mkdir -p $1/quiccrypto/i386
DIST_DIR=vale_aes_concrete_id
rm $1/quiccrypto/*.c
rm $1/quiccrypto/*.h
rm $1/quiccrypto/amd64/*.asm
rm $1/quiccrypto/i386/*.asm
cp $HACL_HOME/secure_api/QuicProvider/*.c $1/quiccrypto
cp $HACL_HOME/secure_api/QuicProvider/*.c $1/quiccrypto
cp $HACL_HOME/secure_api/QuicProvider/*.h $1/quiccrypto
cp $HACL_HOME/secure_api/out/$DIST_DIR/*.c $1/quiccrypto
cp $HACL_HOME/secure_api/out/$DIST_DIR/*.h $1/quiccrypto
cp $HACL_HOME/secure_api/vale/asm/*x86_64*.asm $1/quiccrypto/amd64
cp $HACL_HOME/secure_api/vale/asm/*i686*.asm $1/quiccrypto/i386
cp $HACL_HOME/secure_api/vale/asm/*.c $1/quiccrypto
cp $HACL_HOME/secure_api/vale/asm/*.h $1/quiccrypto
cp $HACL_HOME/code/curve25519/x25519-c/*.c $1/quiccrypto
cp $HACL_HOME/code/curve25519/x25519-c/*.h $1/quiccrypto
cp MLCrypto/*.h $1/quiccrypto
cp $KREMLIN_HOME/kremlib/kremstr.c $1/quiccrypto
cp $KREMLIN_HOME/kremlib/*.h $1/quiccrypto

mkdir -p $1/mipki
rm $1/mipki/*.c
rm $1/mipki/*.h
cp mitls-fstar/src/pki/*.c $1/mipki
cp mitls-fstar/src/pki/*.h $1/mipki
mkdir -p $1/mipki/win
rm $1/mipki/win/*.c
rm $1/mipki/win/*.h
cp mitls-fstar/src/pki/win/*.c $1/mipki/win
cp mitls-fstar/src/pki/win/*.h $1/mipki/win



